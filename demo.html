<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./node_modules/layui.css">
    <link rel="stylesheet" href="./css/demo.min.css">

</head>

<body>
    <div class="detail">
        <div class="biu">
            <div class="biu-title">
                基本信息
            </div>
            <img style="width: 200px; height: 200px;"
                src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTM4IDc5LjE1OTgyNCwgMjAxNi8wOS8xNC0wMTowOTowMSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTcgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjMwQThGMEE0QkU3RjExRTk4NzM0QTIzOTNCN0VDN0U0IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjMwQThGMEE1QkU3RjExRTk4NzM0QTIzOTNCN0VDN0U0Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6MzBBOEYwQTJCRTdGMTFFOTg3MzRBMjM5M0I3RUM3RTQiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MzBBOEYwQTNCRTdGMTFFOTg3MzRBMjM5M0I3RUM3RTQiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz603N/zAAAB40lEQVR42mL8//8/w2AGTAyDHIw6kGIASoO4MC4Qd2OBDBCzE2sHUK0JELuR4waSQxBoERuQug3E7SRo6wTiZfSKYi4g5gBiIRL0MAMxy2gmGXXgUHQgI77ihJGREZRrxYFMTiRhPiC+CMRrgbiESHtWALEWEOuhiX9fpJHwEq8b8EnG31zYAKTqaRxItQvV41vIjWIHOsSiM73S4B8gXgLEv0lNZvRyYDcwPcUC6auDMRffB+IWYIYKANIGg9GBOdDqbPJgLAfXAKN2G5AGhd5dID4IxYfJSI8YgIUKDpwCIoCOXAykFqO1fECZJnqgHbgC6JCbSPxnILcBsRoQBw+GEJSAYhhwg5q7HNosG1R1cS8wqncD6S4s1dqAOxBUP1cDo9sbSOcOxtbMeSCWBeL5g7W5lQDtq4jS04F/6dBY+EdJLgaVazpAzE6kZ3lJdNwvaLuS/AYrCd1RA2g6rAbm5DZS++b0SIOw2Pg2WDMJD6wZP1gd+BOpk44e/RJALDXQDrwJbVV7oTkOVOycBeLVNOnVkThuMx9aHk6BjsWAeoQdQKwOxKnAzDOH1EzCwkBdkAfE0tAGbA5UDNQmrMDlOLqGIDQUQZpsoE1/UI7eCXTcE3KLGcbRMepRBw4wAAgwACp+s8nlljxxAAAAAElFTkSuQmCC"
                alt="logo" srcset="">
            <div class="right-info">

            </div>
        </div>
        <div class="data-record">
            <div class="data-record-title">
                数据记录
                <div class="layui-btn-container">
                    <button id="day" type="button" class="layui-btn layui-btn-primary">最近三天</button>
                    <button id="week" type="button" class="layui-btn layui-btn-primary">最近一周</button>
                    <button id="month" type="button" class="layui-btn layui-btn-primary">最近一月</button>
                </div>
            </div>
            <div class="data-record-content">

            </div>
        </div>
        <div class="classify">
            <button id='realtime' id="day" type="button" class="layui-btn">实时图表</button>
            <button id="history" type="button" class="layui-btn layui-btn-primary">历史数据</button>
            <button id="alarm" type="button" class="layui-btn layui-btn-primary">报警信息</button>
        </div>
        <div class="chartShow">
            <div id="chartShow-temperature">

            </div>
            <div id="chartShow-electric">

            </div>
            <div id="chartShow-voltage">

            </div>
            <div id="chartShow-aftercurrent">

            </div>
            <div id="chartShow-liquidLevel">

            </div>
        </div>

        <div class="historyData" style="display: none;">
            <table class="layui-hide" id="historyData"></table>
        </div>

        <div class="alarmInfo" style="display: none;">
            <table class="layui-hide" id="alarmInfo"></table>
        </div>
    </div>
</body>
<script src="./node_modules/echarts/dist/echarts.min.js"></script>
<script src="./node_modules/layui.js"></script>
<script src="./js/deviceList.js"></script>
<script type="module">
    import {
        baseUrl
    } from './js/params.js'
    layui.use(['element', 'layer', 'table', 'form'], function () {

        var $ = layui.jquery

        var electricSign = []; //电流标志
        var voltageSign = []; //电压标志
        var temperatureSign = []; //温度标志
        var electricRASign = []; //剩余电流标志
        var electricA = []; //A相电流
        var electricB = []; //B相电流
        var electricC = []; //C相电流
        var voltageA = []; //A相电压
        var voltageB = []; //B相电压
        var voltageC = []; //C相电压
        var temperatureA = []; //A相温度
        var temperatureB = []; //B相温度
        var temperatureC = []; //C相温度
        var temperatureE = []; //环境温度
        var electricRA = []; //剩余电流
        var time = []; //时间
        var liquidLevel = [] //液位
        var liquidLevelSign = [] //液位标志



        function getUrl(url) {
            // 先获取href问号以及问号后的内容
            if (url) {
                url = url.substr(url.indexOf("?"))
            } else {
                url = window.location.search
            }
            //判断是否含有问号，有则说明含有参数
            if (url.indexOf("?") !== -1) {
                var str = url.substr(1)
                var strs = str.split("&")
                var obj = new Object()
                for (var i = 0; i < strs.length; i++) {
                    obj[strs[i].split("=")[0]] = strs[i].split("=")[1];
                }

                return obj
            }
            return null
        }



        var infoTitle = {
            a: "电",
            b: "水"
        }

        var infoValue = [{
            value: 1,
            title: "a"
        },
        {
            value: 2,
            title: "b"
        }
        ]


        var aaa = [
            { field: 'id', title: 'ID' }
            , { field: 'username', title: '用户名' }
            , { field: 'sex', title: '性别' }
        ]





        //处理回调
        $.ajax({
            url: baseUrl + "/rest/deviceworkdata/zxlist?token=" + JSON.parse(localStorage.getItem('loginInfo'))
                .token,
            type: 'get',
            data: getUrl(window.location.href),
            success: function (response) {
                const {
                    data, deviceInfo, deviceData
                } = response.rows

                //添加设备基本信息
                $('.right-info').append(
                    `
                    <p>${deviceInfo.imei}</p>
                        <div class="right-content">
                        <p>设备名称：${deviceInfo.location}</p>
                        <p>设备类型：${deviceInfo.typeSign}</p>
                        <p>设备状态：${deviceInfo.state}</p>
                    </div>
                    `
                )

                // console.log(deviceData)
               


                //历史信息表格
                var tableTitle = data.map(item => {
                    return { field: item.dataType , title: item.typeDes }
                })
                tableTitle.unshift({field: 'happen_time' , title: '上报时间'})

                console.log(tableTitle)
                //渲染历史数据表格
                layui.use('table', function () {
                    var table = layui.table;

                    table.render({
                        elem: '#historyData'
                        , data: deviceData
                        , cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                        , cols: [tableTitle]
                    });
                });






                // 水位 03
                if (response.rows.deviceType === '03') {
                    if (response.code === 200) {
                        time = response.rows.time
                        liquidLevelSign.push(data[1].typeDes)
                        data.map(item => {
                            switch (item.dataType) {
                                case "F":
                                    liquidLevel = item.value
                                    break;
                                default:
                                    break;
                            }
                        })
                    }
                    //echars
                    var myChartL = echarts.init(document.getElementById('chartShow-liquidLevel'),
                        null, {
                        renderer: 'svg'
                    });

                    //液位
                    var optionL = {
                        tooltip: {
                            trigger: 'axis'
                        },
                        legend: {
                            data: liquidLevelSign
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        toolbox: {
                            feature: {
                                saveAsImage: {}
                            }
                        },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,
                            data: time
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [{
                            name: '液位',
                            type: 'line',
                            stack: '总量',
                            data: liquidLevel
                        }]
                    };
                    optionL && myChartL.setOption(optionL);

                    var infoMapData = data.map(item => {
                        return `
                        <p>
                            <span class="data-record-content-icon"></span>
                            <span class="data-record-content-detail">${item.typeDes}：${item.value.pop()} ${item.typeUnit}</span>
                        </p>
                    `
                    })
                    var $infoData = `
                    <div class="data-record-content-time">
                        最后上报时间 : ${time.pop()}
                    </div>
                    ${infoMapData.join('')}
                    `
                    $(".data-record-content").append($infoData)

                    // 判断节点是否显示
                    if ($('#chartShow-temperature').children().length === 0) {
                        $('#chartShow-temperature').css('display', 'none')
                    }
                    if ($('#chartShow-electric').children().length === 0) {
                        $('#chartShow-electric').css('display', 'none')
                    }
                    if ($('#chartShow-voltage').children().length === 0) {
                        $('#chartShow-voltage').css('display', 'none')
                    }
                    if ($('#chartShow-aftercurrent').children().length === 0) {
                        $('#chartShow-aftercurrent').css('display', 'none')
                    }
                    if ($('#chartShow-liquidLevel').children().length === 0) {
                        $('#chartShow-liquidLevel').css('display', 'none')
                    }
                } else if (response.rows.deviceType === '01') {
                    if (response.code === 200) {
                        time = response.rows.time
                        voltageSign.push(data[1].typeDes, data[2].typeDes, data[3].typeDes)
                        electricSign.push(data[4].typeDes, data[5].typeDes, data[6].typeDes)
                        temperatureSign.push(data[7].typeDes, data[8].typeDes, data[9].typeDes, data[10]
                            .typeDes)
                        electricRASign.push(data[0].typeDes)
                        data.map(item => {
                            switch (item.dataType) {
                                case "residue_electricity":
                                    electricRA = item.value
                                    break;
                                case "a_voltage":
                                    voltageA = item.value
                                    break;
                                case "b_voltage":
                                    voltageB = item.value
                                    break;
                                case "c_voltage":
                                    voltageC = item.value
                                    break;
                                case "a_electricity":
                                    electricA = item.value
                                    break;
                                case "b_electricity":
                                    electricB = item.value
                                    break;
                                case "c_electricity":
                                    electricC = item.value
                                    break;
                                case "a_temperature":
                                    temperatureA = item.value
                                    break;
                                case "b_temperature":
                                    temperatureB = item.value
                                    break;
                                case "c_temperature":
                                    temperatureC = item.value
                                    break;
                                case "environment_temperature":
                                    temperatureE = item.value
                                    break;
                                default:
                                    break;
                            }
                        })
                    }
                    //echars
                    var myChartA = echarts.init(document.getElementById('chartShow-temperature'),
                        null, {
                        renderer: 'svg'
                    });
                    var myChartV = echarts.init(document.getElementById('chartShow-electric'), null, {
                        renderer: 'svg'
                    });
                    var myChartT = echarts.init(document.getElementById('chartShow-voltage'), null, {
                        renderer: 'svg'
                    });
                    var myChartRA = echarts.init(document.getElementById('chartShow-aftercurrent'),
                        null, {
                        renderer: 'svg'
                    });
                    //电流
                    optionA = {
                        tooltip: {
                            trigger: 'axis'
                        },
                        legend: {
                            data: electricSign
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        toolbox: {
                            feature: {
                                saveAsImage: {}
                            }
                        },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,
                            data: time
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [{
                            name: 'A相电流',
                            type: 'line',
                            stack: '总量',
                            data: electricA
                        },
                        {
                            name: 'B相电流',
                            type: 'line',
                            stack: '总量',
                            data: electricB
                        },
                        {
                            name: 'C相电流',
                            type: 'line',
                            stack: '总量',
                            data: electricC
                        }
                        ]
                    };
                    //电压
                    optionV = {
                        tooltip: {
                            trigger: 'axis'
                        },
                        legend: {
                            data: voltageSign
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        toolbox: {
                            feature: {
                                saveAsImage: {}
                            }
                        },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,
                            data: time
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [{
                            name: 'A相电压',
                            type: 'line',
                            stack: '总量',
                            data: voltageA
                        },
                        {
                            name: 'B相电压',
                            type: 'line',
                            stack: '总量',
                            data: voltageB
                        },
                        {
                            name: 'C相电压',
                            type: 'line',
                            stack: '总量',
                            data: voltageC
                        }
                        ]
                    };
                    //温度
                    optionT = {
                        tooltip: {
                            trigger: 'axis'
                        },
                        legend: {
                            data: temperatureSign
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        toolbox: {
                            feature: {
                                saveAsImage: {}
                            }
                        },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,
                            data: time
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [{
                            name: 'A相温度',
                            type: 'line',
                            stack: '总量',
                            data: temperatureA
                        },
                        {
                            name: 'B相温度',
                            type: 'line',
                            stack: '总量',
                            data: temperatureB
                        },
                        {
                            name: 'C相温度',
                            type: 'line',
                            stack: '总量',
                            data: temperatureC
                        },
                        {
                            name: '环境温度',
                            type: 'line',
                            stack: '总量',
                            data: temperatureE
                        }
                        ]
                    };
                    //剩余电流
                    optionRA = {
                        tooltip: {
                            trigger: 'axis'
                        },
                        legend: {
                            data: electricRASign
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        toolbox: {
                            feature: {
                                saveAsImage: {}
                            }
                        },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,
                            data: time
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [{
                            name: '剩余电流',
                            type: 'line',
                            stack: '总量',
                            data: electricRA
                        }]
                    };
                    optionA && myChartA.setOption(optionA);
                    optionV && myChartV.setOption(optionV);
                    optionT && myChartT.setOption(optionT);
                    optionRA && myChartRA.setOption(optionRA);
                    var infoMapData = data.map(item => {
                        return `
                        <p>
                            <span class="data-record-content-icon"></span>
                            <span class="data-record-content-detail">${item.typeDes}：${item.value.pop()} ${item.typeUnit}</span>
                        </p>
                    `
                    })
                    var $infoData = `
                    <div class="data-record-content-time">
                        最后上报时间 : ${time.pop()}
                    </div>
                    ${infoMapData.join('')}
                    `
                    $(".data-record-content").append($infoData)

                    // 判断节点是否显示
                    if ($('#chartShow-liquidLevel').children().length === 0) {
                        $('#chartShow-liquidLevel').css('display', 'none')
                    }
                }
            },
            error: function () {

            }
        })


        $('.layui-btn').click(function () {
            $(this).removeClass('layui-btn-primary').siblings().addClass('layui-btn-primary')
            var index = $(this).attr('id')
            console.log(index)
            if (index === 'day') {

            } else if (index === 'week') {

            } else if (index === 'month') {

            } else if (index === 'realtime') {
                $(".chartShow").css('display', 'block')
                $(".historyData").css('display', 'none')
                $(".alarmInfo").css('display', 'none')
            } else if (index === 'history') {
                $(".chartShow").css('display', 'none')
                $(".historyData").css('display', 'block')
                $(".alarmInfo").css('display', 'none')
            } else if (index === 'alarm') {
                $(".chartShow").css('display', 'none')
                $(".historyData").css('display', 'none')
                $(".alarmInfo").css('display', 'block')
            }
        })



    })
</script>

</html>